<html>

<meta charset="UTF-8">

<head>
  <!-- 下面这一行引入jQuery库，不要更改 -->
  <script src="jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <link href="c3.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.bundle.min.js"> </script>
  <script src="d3.v3.min.js"></script>
  <script src="c3.min.js"></script>
  <script src="calculator.js"></script>
  <script src="c3_chart.js"></script>
  <script src="multi_chart.js"></script>
  <script src='require.js'></script>

  <script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-103434573-1', 'auto');
  ga('send', 'pageview');
  </script>
</head>

<body>

<h1>World of Warships AP penetration calculator Beta 0.50</h1>

<p>This is a test version based on US NAVY penetration formula and game file data mining.</p>

<p>nation:
<select id="nation" onchange="load_types();"></select>
</p>

<p>ship type:
<select id="shiptype" onchange="load_ships();"></select>
</p>

<p>ship list:
<select id="shiplist" onchange="load_ammo();"></select>
</p>

<p>ammo list:
<select id="ammolist" onchange="ammo_properties();"></select>
</p>
<!--
<p><textarea id="value_loaded"></textarea></p>
-->

<p><div id="ammo_selected_name"></div>
<div id="ammo_selected_airdrag" ></div>
<div  id="ammo_selected_diametr"></div>
<div  id="ammo_selected_mass"></div>
<div id="ammo_selected_krupp"></div>
<div id="ammo_selected_speed"></div></p>

<div id="chart"></div>
<div id="mycanvas">
        <canvas id="canvas" width="1000" height="700" ></canvas>
</div>
<script>
var ship_info;
var the_ship;
var glob_nation;
function load_nation(){
  //$.getJSON(['./nations.json'],function(file){
  //  console.log(file);
    natio=["Commonwealth",
      "Japan",
      "United_Kingdom",
      "France",
      "Pan_Asia",
      "USA",
      "Germany",
      "Poland",
      "Italy",
      "Russia"]
      //console.log(natio);
    $("#nation").replaceWith("<select id=\"nation\" onchange=\"load_types();\"></select>");  // replace the old select with a new empty select
    for(var i in natio) {
      $("#nation")[0].innerHTML += "<option value=\"" + natio[i] + "\">" + natio[i] + "</options>";  // append option
  }
//});
}

function load_types(){
  nation_selector = $("#nation")[0];
  selected_nation = nation_selector.options[nation_selector.selectedIndex].value;
  console.log(selected_nation);
  glob_nation=selected_nation;
  $.ajax({
    url: selected_nation+"/shiptypes.json",
    //url: "nations.json",
    type: "GET",
    dataType: "json",
    success: function (data) {
        //select_from_keys(data)
        console.log(data);
        $("#shiptype").replaceWith("<select id=\"shiptype\" onchange=\"load_ships();\"></select>");  // replace the old select with a new empty select
        for(var i in data) {
          $("#shiptype")[0].innerHTML += "<option value=\"" + data[i] + "\">" + data[i] + "</options>";  // append option
        }
        load_ships(glob_nation);
        console.log(glob_nation);
      //  ammo_properties();
        //console.log(pen_dict.distance);
      }
  });
}

function load_ships(){
  file_selector = $("#shiptype")[0];
  selected_shiptype = glob_nation+"_"+file_selector.options[file_selector.selectedIndex].value;
  console.log(selected_shiptype);
  $.ajax({
    url: glob_nation+"/"+selected_shiptype+".json",
    //url: "nations.json",
    type: "GET",
    dataType: "json",
    success: function (data) {
        //select_from_keys(data)
        ship_info=data;
        console.log(data);
        select_from_keys(data)
  //      $("#value_loaded")[0].innerHTML = Object.keys(data)
//        $("#shiplist").replaceWith("<select id=\"shiplist\" onchange=\"load_types();\"></select>");  // replace the old select with a new empty select
  //      for(var i in data) {
    //      $("#shiplist")[0].innerHTML += "<option value=\"" + data[i] + "\">" + data[i] + "</options>";  // append option
      //  }
        console.log(Object.keys(data))
        load_ammo();
        //ammo_properties();
        //console.log(pen_dict.distance);
      }
  });
}

function load_ammo(){
  ship_selector = $("#shiplist")[0];
  ship_name = ship_selector.options[ship_selector.selectedIndex].value;
  selected_ship = ship_info[ship_name];
  the_ship=selected_ship;
  console.log(selected_ship.ammo_num);
  artylist=[]
  for(i=0;i<selected_ship.ammo_num;i++){
    artylist.push("Artillery"+i.toString());
  }
  $("#ammolist").replaceWith("<select id=\"ammolist\" onchange=\"ammo_properties();\"></select>");  // replace the old select with a new empty select
  for(var i in artylist) {
    $("#ammolist")[0].innerHTML += "<option value=\"" + artylist[i] + "\">" + artylist[i] + "</options>";  // append option
  }
  ammo_properties();
        //console.log(pen_dict.distance);
}

load_nation();
load_types();
//console.log(glob_nation);

function load_value(nation) {
    file_selector = $("#file_to_read")[0];
    selected_filename = file_selector.options[file_selector.selectedIndex].value;
    $.ajax({
      url: selected_filename+".json",
      //url: nation+"/"+selected_filename+".json",

      type: "GET",
      dataType: "json",
      success: function (data) {
        ship_info=data;
          select_from_keys(data)
          $("#value_loaded")[0].innerHTML = Object.keys(data)
          ammo_properties();
          //console.log(pen_dict.distance);

      }
    });
  }

  //load_value();  // 在页面载入的时候读取默认的文件中的内容

    function select_from_keys(data) {
      console.log(Object.keys(data).length)
      datakey=Object.keys(data);
      ship_tuple=[];
      for(var i in datakey){
        ship_tuple.push([[data[datakey[i]].Tier],[datakey[i]]]);
      }
      ship_tuple.sort(function(a, b) {
          a = a[0];
          b = b[0];
          return a-b;
          //return a < b ? -1 : (a > b ? 1 : 0);
      });
      $("#shiplist").replaceWith("<select id=\"shiplist\" onchange=\"load_ammo();\"></select>");  // replace the old select with a new empty select
      for(var i in ship_tuple) {
        $("#shiplist")[0].innerHTML += "<option value=\"" + ship_tuple[i][1] + "\">" + "Tier "+ship_tuple[i][0]+" "+(ship_tuple[i][1].toString()).substring(8) + "</options>";  // append option
      }
    }

    function ammo_properties(){
      // display ammo information
      ammo_selector = $("#ammolist")[0];
      ammo_name = ammo_selector.options[ammo_selector.selectedIndex].value;
      selected_ammo=the_ship[ammo_name]
      console.log(selected_ammo.AP.bulletName);
      var c_D,Dia,mass,krupp,v_0;
      c_D=selected_ammo.AP.bulletAirDrag;
      Dia=selected_ammo.AP.bulletDiametr;
      mass=selected_ammo.AP.bulletMass;
      krupp=selected_ammo.AP.bulletKrupp;
      v_0=selected_ammo.AP.bulletSpeed;
      $("#ammo_selected_name")[0].innerHTML = "Ammo Name: "+selected_ammo.AP.bulletName;
      $("#ammo_selected_airdrag")[0].innerHTML = "Air Drag Coeff: "+selected_ammo.AP.bulletAirDrag;
      $("#ammo_selected_diametr")[0].innerHTML = "Caliber: "+1000*selected_ammo.AP.bulletDiametr+" mm";
      $("#ammo_selected_mass")[0].innerHTML = "Mass: "+selected_ammo.AP.bulletMass+" kg";
      $("#ammo_selected_krupp")[0].innerHTML = "Krupp: "+selected_ammo.AP.bulletKrupp;
      $("#ammo_selected_speed")[0].innerHTML = "Muzzle Velocity: "+selected_ammo.AP.bulletSpeed+" m/s";

      // draw ammo penetration curve
      pen_dict= calculator(mass,Dia,c_D,v_0,krupp);
      update_multichart(pen_dict);
    }

</script>
<script type='text/javascript' id='clustrmaps' src='//cdn.clustrmaps.com/map_v2.js?cl=ffffff&w=150&t=n&d=HEBKSdOvPBJay6vAQpEnzJ5sVMbNwEFSiVLQ9_78hkw'></script>
